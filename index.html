<!DOCTYPE html>
<html lang="id">
<head>
	<meta charset="UTF-8">
	<title>AI Personal Assistant</title>

	<!-- Meta Tags untuk PWA & Pengalaman Mobile (iOS) -->
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, interactive-widget=resizes-content">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="apple-mobile-web-app-title" content="AI Assistant">
	<meta name="theme-color" content="#f9fafb">

	<!-- Memuat Pustaka Eksternal dari CDN -->
	<script src="https://cdn.tailwindcss.com"></script>
	<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

	<!-- Memuat React, ReactDOM, dan Babel untuk JSX di Browser -->
	<script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
	<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
	<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

	<style>
	/* PERBAIKAN: CSS Global untuk Layout Full-Screen yang Stabil */
	html,
	body,
	#root {
		height: 100%;
		overflow: hidden;
		/* Mencegah scroll di level body */
		overscroll-behavior: none;
		/* Menghilangkan efek 'karet' di semua browser */
	}

	/* Styles untuk merender konten Markdown dari AI dengan rapi */
	.ai-chat-content * {
		margin: 0 !important;
		padding: 0 !important;
		line-height: 1.5;
	}

	.ai-chat-content p,
	.ai-chat-content ul,
	.ai-chat-content ol,
	.ai-chat-content blockquote,
	.ai-chat-content pre,
	.ai-chat-content table {
		margin-bottom: 0.6em !important;
	}

	.ai-chat-content ul,
	.ai-chat-content ol {
		padding-left: 1.5rem !important;
	}

	.ai-chat-content ul {
		list-style: disc outside !important;
	}

	.ai-chat-content ol {
		list-style: decimal outside !important;
	}

	.ai-chat-content li {
		padding-left: 0.25rem !important;
		margin-bottom: 0.25em !important;
	}

	.ai-chat-content > :last-child,
	.ai-chat-content li:last-child {
		margin-bottom: 0 !important;
	}

	.ai-chat-content table {
		width: 100%;
		border-collapse: collapse;
	}

	.ai-chat-content th,
	.ai-chat-content td {
		border: 1px solid #e2e8f0;
		padding: 0.4rem 0.6rem !important;
	}

	.ai-chat-content th {
		background-color: #f7fafc;
	}

	.ai-chat-content code {
		background-color: #edf2f7;
		padding: 0.2em 0.4em !important;
		font-size: 85%;
		border-radius: 3px;
	}

	.ai-chat-content pre {
		background-color: #2d3748;
		color: #e2e8f0;
		padding: 0.75rem !important;
		border-radius: 0.5rem;
		overflow-x: auto;
	}

	.ai-chat-content pre code {
		background-color: transparent;
		color: inherit;
	}

	.ai-chat-content a {
		color: #4299e1;
		text-decoration: underline;
	}

	.ai-chat-content blockquote {
		border-left: 0.25em solid #e2e8f0;
		padding-left: 1em !important;
		color: #718096;
	}
	</style>
</head>
<body class="bg-gray-50">
	<!-- Di sinilah aplikasi React akan dimuat -->
	<div id="root"></div>

	<!-- Kode Aplikasi React kita, diterjemahkan oleh Babel -->
	<script type="text/babel">
		// --- Konstanta dan Konfigurasi ---
        const API_BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODELS = {
            CHAT: 'gemini-2.5-flash-preview-05-20',
            IMAGE: 'gemini-2.5-flash-image-preview'
        };
        const IMAGE_COMMAND = '/gambar ';

        // --- Komponen Anak (Child Components) ---
        const AiMessageContent = React.memo(({ part, isMarkedLoaded }) => {
            if (part.type.startsWith('image/')) {
                return <img src={part.content} alt="Generated Content" className="mt-2 rounded-lg max-w-full h-auto" />;
            }
            if (part.type === 'text') {
                const htmlContent = isMarkedLoaded && window.marked ? window.marked.parse(part.content) : part.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return <div className="ai-chat-content text-sm sm:text-base break-words" dangerouslySetInnerHTML={{ __html: htmlContent }} />;
            }
            return null;
        });

        const MessageBubble = React.memo(({ msg, isMarkedLoaded }) => {
            const isUser = msg.role === 'user';
            const bubbleClasses = isUser ? 'bg-blue-100 text-blue-900 rounded-br-none' : 'bg-gray-100 text-gray-800 rounded-bl-none';
            const ModelAvatar = () => (<div className="w-8 h-8 bg-indigo-500 rounded-full flex items-center justify-center text-white text-sm font-bold flex-shrink-0">AI</div>);
            
            return (
                <div className={`flex items-start gap-2 sm:gap-3 ${isUser ? 'justify-end' : 'justify-start'}`}>
                    {!isUser && <ModelAvatar />}
                    <div className={`${isUser ? 'max-w-[60%]' : 'max-w-full'} rounded-2xl p-3 sm:p-4 shadow-sm ${bubbleClasses}`}>
                        {isUser ? (
                             <p className="text-sm sm:text-base whitespace-pre-wrap break-words">{msg.parts[0].content}</p>
                        ) : (
                            msg.parts.map((part, index) => <AiMessageContent key={index} part={part} isMarkedLoaded={isMarkedLoaded} />)
                        )}
                    </div>
                </div>
            );
        });

        const ChatInputForm = React.memo(({ value, onChange, onSubmit, isLoading, hasApiKey }) => {
            return (
                <form onSubmit={onSubmit} className="max-w-3xl mx-auto px-4 sm:px-6">
                    {/* The container has the border, background, and rounded shape */}
                    <div className="flex items-center w-full h-14 bg-white border border-gray-300 rounded-full shadow-sm focus-within:ring-2 focus-within:ring-indigo-400 transition-all duration-200">
                        
                        {/* Upload Button */}
                        <button
                            type="button"
                            className="m-1 w-12 h-12 bg-gray-100 text-gray-600 rounded-full flex items-center justify-center focus:outline-none flex-shrink-0 transition-colors"
                            aria-label="Tambah file"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                        </button>
                        
                        {/* Text Input */}
                        <input 
                            type="text" 
                            value={value} 
                            onChange={onChange} 
                            placeholder={hasApiKey ? "Ketik pesan atau '/gambar'..." : "Masukkan API Key Anda..."} 
                            className="w-full h-full bg-transparent border-none focus:outline-none focus:ring-0 text-sm sm:text-base placeholder-gray-500 px-2" 
                            disabled={isLoading} 
                        />
                        
                        {/* Send Button */}
                        <button 
                            type="submit" 
                            disabled={isLoading || !value} 
                            className="m-1 w-12 h-12 bg-indigo-500 text-white rounded-full flex items-center justify-center transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed flex-shrink-0" 
                            aria-label="Kirim pesan"
                        >
                            {isLoading ? (
                                <div className="w-6 h-6 border-2 border-white border-t-transparent rounded-full animate-spin" aria-label="Memuat"></div>
                            ) : (
                                <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M5 12h14" /><path d="m12 5 7 7-7 7" /></svg>
                            )}
                        </button>
                    </div>
                </form>
            );
        });

        // --- Logika API ---
        async function fetchModelResponse(prompt, apiKey) {
            const isImagePrompt = prompt.toLowerCase().startsWith(IMAGE_COMMAND);
            const model = isImagePrompt ? MODELS.IMAGE : MODELS.CHAT;
            const finalPrompt = isImagePrompt ? prompt.substring(IMAGE_COMMAND.length) : prompt;
            const parts = [{ text: finalPrompt }];
            
            const apiUrl = `${API_BASE_URL}${model}:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts }] };
            
            if (model === MODELS.IMAGE) {
                payload.generationConfig = { responseModalities: ['TEXT', 'IMAGE'] };
            } else {
                payload.tools = [{ "google_search": {} }];
            }

            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error?.message || `Request gagal dengan status ${response.status}`);
            }

            const result = await response.json();
            if (!result.candidates?.length) {
                const reason = result.promptFeedback?.blockReason || "Konten diblokir atau tidak ada respons valid";
                throw new Error(`Permintaan diblokir: ${reason}.`);
            }

            const responseParts = result.candidates[0].content?.parts;
            if (!responseParts) {
                throw new Error("Respons dari API tidak memiliki format konten yang valid.");
            }
            
            return responseParts.map(part => {
                if (part.text) return { type: 'text', content: part.text };
                if (part.inlineData) return { type: part.inlineData.mimeType, content: `data:${part.inlineData.mimeType};base64,${part.inlineData.data}` };
                return null;
            }).filter(Boolean);
        }

        // --- Komponen Utama Aplikasi ---
        function App() {
            const [apiKey, setApiKey] = React.useState('');
            const [messages, setMessages] = React.useState([
                { role: 'model', parts: [{ type: 'text', content: 'Selamat datang di Asisten AI. Untuk memulai, silakan masukkan API Key dari Google AI Studio Anda.' }] }
            ]);
            const [inputValue, setInputValue] = React.useState('');
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState(null);
            const [isMarkedLoaded, setIsMarkedLoaded] = React.useState(false);

            const chatContainerRef = React.useRef(null);

            // --- Hooks ---
            React.useEffect(() => {
                chatContainerRef.current?.scrollTo({ top: chatContainerRef.current.scrollHeight, behavior: 'smooth' });
            }, [messages]);
            
            React.useEffect(() => {
                if (window.marked) setIsMarkedLoaded(true);
            }, []);

            React.useEffect(() => {
                let lastTouchEnd = 0;
                const preventDoubleTap = (event) => {
                    const now = Date.now();
                    if (now - lastTouchEnd <= 300) event.preventDefault();
                    lastTouchEnd = now;
                };
                document.addEventListener('touchend', preventDoubleTap, { passive: false });

                const setupMobileViewportFix = () => {
                    if (!window.visualViewport) return;
                    let lastHeight = window.visualViewport.height;
                    const handler = () => {
                        const newHeight = window.visualViewport.height;
                        if (newHeight > lastHeight) {
                            setTimeout(() => {
                                window.scrollTo(0, 0);
                                chatContainerRef.current?.scrollTo({ top: chatContainerRef.current.scrollHeight, behavior: 'smooth' });
                            }, 50);
                        }
                        lastHeight = newHeight;
                    };
                    window.visualViewport.addEventListener('resize', handler);
                    return () => window.visualViewport.removeEventListener('resize', handler);
                };
                const cleanupViewportFix = setupMobileViewportFix();
                
                return () => {
                    document.removeEventListener('touchend', preventDoubleTap);
                    cleanupViewportFix();
                };
            }, []);

            // --- Handlers ---
            const handleApiKeySubmit = (key) => {
                if (key.startsWith('AIzaSy') && key.length > 35) {
                    setApiKey(key);
                    setMessages([{ role: 'model', parts: [{ type: 'text', content: 'Terima kasih! API Key disimpan. Anda siap memulai.' }] }]);
                    setError(null);
                } else {
                    setError('API Key tidak valid. Mohon periksa kembali.');
                }
            };
            
            const handleSendMessage = async (e) => {
                e.preventDefault();
                const trimmedInput = inputValue.trim();
                if (!trimmedInput) return;

                if (!apiKey) {
                    handleApiKeySubmit(trimmedInput);
                    setInputValue('');
                    return;
                }
                
                const userMessageParts = [{type: 'text', content: trimmedInput}];

                setError(null);
                setIsLoading(true);
                setMessages(prev => [...prev, { role: 'user', parts: userMessageParts }]);
                setInputValue('');
                
                try {
                    const modelParts = await fetchModelResponse(trimmedInput, apiKey);
                    setMessages(prev => [...prev, { role: 'model', parts: modelParts }]);
                } catch (err) {
                    console.error('API call failed:', err);
                    const errorMessage = `Maaf, terjadi kesalahan: ${err.message}`;
                    setError(errorMessage);
                    setMessages(prev => [...prev, { role: 'model', parts: [{ type: 'text', content: errorMessage }] }]);
                } finally {
                    setIsLoading(false);
                }
            };
            
            return (
                <div className="h-full w-full bg-gray-50 font-sans flex flex-col antialiased">
                    <header className="bg-white/70 backdrop-blur-lg border-b border-gray-200 p-4 shadow-sm z-10 flex-shrink-0">
                        <h1 className="text-lg sm:text-xl font-bold text-gray-800 text-center">AI Personal Assistant</h1>
                    </header>
                    
                    <main ref={chatContainerRef} className="flex-1 overflow-y-auto w-full max-w-3xl mx-auto p-4 sm:p-6 space-y-6">
                        {messages.map((msg, index) => <MessageBubble key={index} msg={msg} isMarkedLoaded={isMarkedLoaded} />)}
                    </main>

                    <footer className="bg-white/70 backdrop-blur-lg border-t border-gray-200 pt-3 pb-4 sm:pb-6 flex-shrink-0">
                        {error && <p className="max-w-3xl mx-auto text-red-500 text-center text-sm mb-2 px-4 sm:px-6">{error}</p>}
                        <ChatInputForm 
                            value={inputValue}
                            onChange={(e) => setInputValue(e.target.value)}
                            onSubmit={handleSendMessage}
                            isLoading={isLoading}
                            hasApiKey={!!apiKey}
                        />
                    </footer>
                </div>
            );
        }

        // Memuat aplikasi React ke dalam DOM
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

